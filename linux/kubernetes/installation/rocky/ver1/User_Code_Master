echo ">>>> K8S Controlplane config Start <<<<"
 
echo "[TASK 1] Initial Kubernetes - Pod CIDR 172.16.0.0/16 , Service CIDR 172.200.0.0/16 , API Server 172.30.100.10"
kubeadm init --token 123456.1234567890123456 --token-ttl 0 --pod-network-cidr=172.16.0.0/16 --apiserver-advertise-address=$(hostname -I | awk '{print $1}') --service-cidr 172.200.0.0/16 --kubernetes-version=v1.31.0 >> kubeadm-init-result.txt
 
# ì¼ë°˜ì€ apiserver-advertise-address=$(hostname -I)
# ë©€í‹°ëŠ” control-plane-endpoint:6443 --upload-certs
#--config : ì´ˆê¸°í™”ì— ì‚¬ìš©í•  êµ¬ì„± íŒŒì¼ì„ ì§€ì •
#--token : í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ í—ˆìš©í•˜ëŠ” í† í°ì„ ì´ˆê¸°í™”
#--pod-network-cidr : í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ Pod ë„¤íŠ¸ì›Œí¬ CIDR ë²”ìœ„ë¥¼ ì§€ì •
#--apiserver-advertise-address : API ì„œë²„ê°€ í¼ë¸”ë¦­ ì—”ë“œí¬ì¸íŠ¸ì— ëŒ€í•´ ì•Œë¦´ IP ì£¼ì†Œë¥¼ ì§€ì •
#--apiserver-cert-extra-sans : ë§ˆìŠ¤í„° ë…¸ë“œ ì¸ì •ìŠ¤ì— ì¶”ê°€í•  DNS ì´ë¦„ì„ ì§€ì •
#--control-plane-endpoint : ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ êµ¬ì„±ìš”ì†Œê°€ ì„œë¡œ í†µì‹ í•˜ëŠ”ë° ì‚¬ìš©í•  ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì§€ì •
#--cri-socket : ì‚¬ìš©í•  CRIì˜ ì†Œì¼“ì„ ì§€ì •
 
echo "[TASK 2] Setting kube config file"
mkdir -p /root/.kube
cp -i /etc/kubernetes/admin.conf /root/.kube/config
chown $(id -u):$(id -g) /root/.kube/config
 
echo "[TASK 3] Source the completion"
echo 'source <(kubectl completion bash)' >> /etc/profile

echo "[TASK 4] Alias kubectl to k"
echo 'alias k=kubectl' >> /etc/profile
echo 'complete -F __start_kubectl k' >> /etc/profile
 
echo "[TASK 5] Install Kubectx & Kubens & Kubeneat"
git clone https://github.com/ahmetb/kubectx /opt/kubectx
ln -s /opt/kubectx/kubens /usr/local/bin/kubens
ln -s /opt/kubectx/kubectx /usr/local/bin/kubectx
 
echo "[TASK 6] Install Kubeps"
git clone https://github.com/jonmosco/kube-ps1.git /root/kube-ps1
cat <<"EOT" >> /root/.bash_profile
source /root/kube-ps1/kube-ps1.sh
KUBE_PS1_SYMBOL_ENABLE=true
KUBE_PS1_SYMBOL_DEFAULT=ğŸ¤
function get_cluster_short() {
  echo "$1" | cut -d . -f1
}
KUBE_PS1_CLUSTER_FUNCTION=get_cluster_short
KUBE_PS1_SUFFIX=') '
PS1='$(kube_ps1)'$PS1
EOT


echo "[TASK 7] Install Helm"
curl -s https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

### ë°‘ì—ê±´ ì§„í–‰í•˜ì§€ë§ì ë¬¸ì œê°€ ìˆìŒ
echo "[TASK 8] Install Packages"
git clone -b v3.5.15 https://github.com/etcd-io/etcd.git
cd etcd
./build.sh #ì—¬ê¸°ì„œ ë¬¸ì œ ë°œìƒ
echo 'export PATH="$PATH:$(pwd)/bin"' >> /etc/profile
cd /root
#kubectl apply -f https://github.com/kubetail-org/kubetail/releases/latest/download/kubetail-clusterauth.yaml

 
echo ">>>> K8S Controlplane Config End <<<<"
